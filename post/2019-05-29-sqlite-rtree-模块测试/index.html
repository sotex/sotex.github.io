  <!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <title> SQLite R*Tree 模块测试 &middot; 风吹过 </title>
    
    <link rel="stylesheet" type="text/css" href="http://sotex.github.io//css/uno.min.css" />
    <link rel="stylesheet" type="text/css" href="http://sotex.github.io//css/lightGallery.css" />
    
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.ico">
    
    <link href="" rel="alternate" type="application/rss+xml" title="风吹过" />
    
    <script src="http://sotex.github.io//js/jquery.min.js"></script>
    <script src="http://sotex.github.io//js/main.min.js">
    </script>
</head>

  <body>
    <div id="scriptHeader">
    <span class="mobile btn-mobile-menu">
            <i class="fa fa-bars btn-mobile-menu__icon"></i>
            <i class="fa fa-times btn-mobile-close__icon hidden"> </i>
    </span>
    <header class="
        
            panel-cover panel-cover--collapsed
        " >
    <div class="panel-main">
        <div class="panel-main__inner panel-inverted">
            <div class="panel-main__content"> 
                <a href="http://sotex.github.io//" title="link to homepage for 风吹过"> <img src="/images/user.png" width="80" alt="风吹过 logo" class="panel-cover__logo logo" /> </a> 
                <h1 class="panel-cover__title panel-title">
                    <a href="http://sotex.github.io//"  title="link to homepage for 风吹过">风吹过</a>
                </h1>
                <hr class="panel-cover__divider" />
                <p class="panel-cover__description">  以前，晚餐后在学校田径场的大榕树下，散散步吹吹风，累了就去图书馆看看书，感觉真好。  </p>
                <hr class="panel-cover__divider panel-cover__divider--secondary" />
                <div class="navigation-wrapper">
                    <nav class="cover-navigation cover-navigation--primary">
                        <ul class="navigation">
                            <li class="navigation__item"><a href="http://sotex.github.io/#blog" title="查看 风吹过 博客" class="blog-button">博客</a> </li></br>
                            <li class="navigation__item"><a href="/pages/about.html" title="查看简介 " class="blog-button">简介</a> </li></br> 
                            
                       </ul>
                    </nav> <nav class="cover-navigation navigation--social">
    <ul class="navigation"> 
	
        
        <li class="navigation__item">
            <a href="http://cnblogs.com/oloroso" title="@oloroso 博客园"> <i class='fa fa-twitter'></i> <span class="label">cnblogs</span> </a>
        </li> 
	
	
        
        <li class="navigation__item">
            <a href="https://github.com/sotex" title="sotex on github"> <i class='fa fa-github'></i> <span class="label">Github</span> </a>
        </li>  </br>
	
	
	
        
        <li class="navigation__item">
            <a href="mailto:ymwh@foxmail.com" title="Email ymwh@foxmail.com"> <i class='fa fa-envelope-o'></i> <span class="label">Email</span> </a>
        </li>  </ul>
</nav>
 </div>
            </div>
        </div>
        <div class="panel-cover--overlay"></div>
    </div>
</header>
</div>
<noscript>
    <style>
        #scriptHeader {display:none;}
        .navigation-wrapper{
            display: block;
            top: 0;
        }
    </style>

    <header class="panel-cover panel-cover--collapsed" style="background-image: url()">
        <div class="panel-main">
            <div class="panel-main__inner panel-inverted">
                <div class="panel-main__content"> 
                    <a href="http://sotex.github.io//" title="link to homepage for 风吹过"> <img src="/images/user.png" width="80" alt="风吹过 logo" class="panel-cover__logo logo" /> </a> 
                    <h1 class="panel-cover__title panel-title">
                        <a href="http://sotex.github.io//"  title="link to homepage for 风吹过">风吹过</a>
                    </h1>
                    <hr class="panel-cover__divider" />
                    <p class="panel-cover__description">  以前，晚餐后在学校田径场的大榕树下，散散步吹吹风，累了就去图书馆看看书，感觉真好。  </p>
                    <hr class="panel-cover__divider panel-cover__divider--secondary" />
                    <div class="navigation-wrapper">
                        <nav class="cover-navigation cover-navigation--primary">
                            <ul class="navigation">
                                <li class="navigation__item"><a href="http://sotex.github.io//#blog" title="查看 风吹过 博客" class="blog-button">博客</a> </li></br>
                                <li class="navigation__item"><a href="/pages/about.html" title="查看简介" class="blog-button">简介</a> </li></br> 
                                
                           </ul>
                        </nav> <nav class="cover-navigation navigation--social">
    <ul class="navigation"> 
	
        
        <li class="navigation__item">
            <a href="http://cnblogs.com/oloroso" title="@oloroso 博客园"> <i class='fa fa-twitter'></i> <span class="label">cnblogs</span> </a>
        </li> 
	
	
        
        <li class="navigation__item">
            <a href="https://github.com/sotex" title="sotex on github"> <i class='fa fa-github'></i> <span class="label">Github</span> </a>
        </li>  </br>
	
	
	
        
        <li class="navigation__item">
            <a href="mailto:ymwh@foxmail.com" title="Email ymwh@foxmail.com"> <i class='fa fa-envelope-o'></i> <span class="label">Email</span> </a>
        </li>  </ul>
</nav>
 </div>
                </div>
            </div>
            <div class="panel-cover--overlay"></div>
        </div>
    </header>
</noscript>

    <div class="content-wrapper">
      <div class="content-wrapper__inner">
        <div class="post">
          <h1>SQLite R*Tree 模块测试</h1>
          <span class="post-date">2019年05月29日</span>
          

<h1 id="sqlite-r-tree-模块测试">SQLite R*Tree 模块测试</h1>

<p>[TOC]
<a href="http://www.cnblogs.com/oloroso/archive/2019/05/29/10941099.html">博客园原文地址 http://www.cnblogs.com/oloroso/archive/2019/05/29/10941099.html</a></p>

<p>相关参考：</p>

<blockquote>
<p><a href="https://www.cnblogs.com/oloroso/p/9579720.html">MySQL空间索引简单使用</a></p>

<p><a href="https://www.cnblogs.com/oloroso/p/9777141.html">MongoDB地理空间数据存储及检索</a></p>

<p><a href="https://www.sqlite.org/rtree.html">The SQLite R*Tree Module</a></p>

<p><a href="https://www.sqlite.org/mmap.html">Memory-Mapped I/O</a></p>

<p><a href="https://sqlite.org/inmemorydb.html">In-Memory Databases</a></p>

<p><a href="https://libspatialindex.org/">libspatialindex</a></p>

<p><a href="https://en.wikipedia.org/wiki/R*_tree">R* tree - Wikipedia</a></p>
</blockquote>

<p>我另外做了GEOS STRtree/Quadtree 空间检索的性能，测试代码和数据可见<a href="https://github.com/sotex/Spatial_Index_Test">Spatial_Index_Test</a></p>

<h2 id="1-sqlite-r-tree-模块特性简介">1、SQLite R*Tree 模块特性简介</h2>

<p>关于SQLite的空间索引相关介绍可以查看官方文档 <a href="https://www.sqlite.org/rtree.html">The SQLite R*Tree Module</a> ，这里只做简单的介绍。</p>

<p>1、<strong>SQLite R *Tree</strong>模块实现部分在其源代码内（<a href="https://www.sqlite.org/download.html">源码下载页面</a>），无需另外合并。但是默认是没有启用的，启用需要定义<code>SQLITE_ENABLE_RTREE=1</code>宏再编译。</p>

<p>2、<strong>SQLite R *Tree</strong>模块采用虚拟表实现，每个R *Tree索引都是一个虚拟表。对于这个表，其第一列必须是64位有符号整数类型，作为主键。其它的列（2-12列）根据空间维度确定，每个维度包含一对（两列），分别是该维度的最小和最大值。例如：一维R *Tree索引虚拟表包含3列，分别是<strong>Int64主键| 最小值| 最大值</strong>；二维R*Tree索引虚拟表包含5列，分别是<strong>Int64主键| 第一维最小值| 第一维最大值| 第二维最小值| 第二维最大值</strong>；3、4、5维R*Tree索引虚拟表列数情况的以此论推，<strong>SQLite R *Tree</strong>实现不支持宽度超过5维的R *树。</p>

<p>3、对于各个维度的最大最小值列，SQLite中可以使用<code>int32</code>或者<code>float32</code>类型进行数据存储。与其它常规表中的列不同，这里存储就是二进制类型的值，而不是转换为字符串。如果在插入数据的时候，使用了这两者之外的类型，则会进行隐式转换。</p>

<pre><code class="language-sqlite">    -- 创建整型坐标rtree索引虚拟表
    CREATE VIRTUAL TABLE intrtree USING rtree_i32(id,x0,x1,y0,y1,z0,z1);
    -- 创建浮点型坐标rtree索引虚拟表
    CREATE VIRTUAL TABLE floatrtree USING rtree(id,x0,x1,y0,y1,z0,z1);
</code></pre>

<p>4、<strong>SQLite R *Tree</strong>中查询并不限制查询的维度一定要与所查询的表中的维度一致，可以仅查询其中的某几个维度（如3维空间仅查询2个维度）。一般来说，约束（维度）越多，查询的范围框越小，速度越快。</p>

<p>5、默认情况下使用<code>float32</code>存储坐标值，当无法精确表示传入值时，下限坐标向下舍入，上限坐标向上舍入，因此边界框可能略大于指定，但永远不会变小。这在查询某个<strong>范围之外</strong>的数据时，可能会有极小的误差。</p>

<p>6、对于<strong>3.24.0</strong>之前的版本，<strong>SQLite R *Tree</strong>索引虚拟表仅能存储整数主键和坐标值列，其它的信息需要另存于其它表中（通过主键进行关联）。从3.24.0版本开始，<strong>SQLite R *Tree</strong>索引虚拟表可以存储任意类型数据的辅助列，辅助列必须以<code>+</code>开头，最多可以存储100个辅助列。</p>

<pre><code class="language-sqlite">    CREATE VIRTUAL TABLE demo_index2 USING rtree(
       id,              -- 64位整型主键
       minX, maxX,      -- X方向最小最大值
       minY, maxY,      -- Y方向最小最大值
       +objname TEXT,   -- 辅助列 文本类型
       +objtype TEXT,   -- 辅助列 文本类型
       +boundary BLOB   -- 辅助列 二进制数据
    );
</code></pre>

<p>7、可以自定义R-Tree查询，以便实现非矩形框碰撞。这需要通过<code>sqlite3_rtree_query_callback</code>（新，3.8.5开始提供）或<code>sqlite3_rtree_geometry_callback</code>（旧）注册查询SQL语句和匹配检测回调。相关信息在SQLite网站上有详细介绍。</p>

<p>8、一个<strong>SQLite R *Tree</strong>会附带三个影子表，用于存储数据，分别是<code>虚拟表名_node</code>（存储节点） <code>虚拟表名_parent</code>（存储父节点） <code>虚拟表名_rowid</code>（存储节点的rowid）。</p>

<p>9、可以使用<code>SELECT rtreecheck('虚拟表名')</code>来对R-Tree索引进行完整性和正确性检查。</p>

<h2 id="2-sqlite-r-tree-模块简单测试代码">2、SQLite R*Tree 模块简单测试代码</h2>

<p>写了一个简单的测试程序来测试一下<strong>R *Tree</strong>树的速度，结果还是可以的。（可用，并不是最佳）</p>

<p>我的机器环境是：</p>

<blockquote>
<p>Windows 10 1903 x64专业版</p>

<p>AMD 锐龙 2600X</p>

<p>DDR4 2400 8G</p>

<p>编译器：VS2017 Native x64</p>
</blockquote>

<p>使用本地文件的时候，十万条数据插入时间大概在2秒以内，查询一个5x5度大小的范围，时间基本在0.07秒以内；使用内存模式时，插入时间大概在1.8秒以内，查询一个5x5度大小的范围，时间基本在0.04秒以内。</p>

<p><strong>注意：编译SQLite的时候要定义<code>SQLITE_ENABLE_RTREE</code>宏，开启RTree索引支持。</strong></p>

<pre><code class="language-c">#include &quot;sqlite/sqlite3.h&quot;
#include&lt;time.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;stdio.h&gt;

// 因为仅仅是进行一下试用测试，所以有些地方就没有处理，包括close

int main() 
{
    sqlite3* db = NULL;
    int rc = sqlite3_open(&quot;:memory:&quot;, &amp;db);
    // int rc = sqlite3_open(&quot;D:/sqlite_rtree/test.db&quot;, &amp;db);
    if (rc != SQLITE_OK) 
    {
        return -1;
    }
    
    char* errmsg;
    // 创建RTree索引虚拟表
    rc = sqlite3_exec(db,
                      &quot;CREATE VIRTUAL TABLE demo_index USING rtree(id,minX, maxX,minY, maxY,+axucol INTEGER NOT NULL)&quot;,
                      NULL, NULL, &amp;errmsg);
    if (rc != SQLITE_OK) 
    {
        printf(&quot;%4d Error:%sn&quot;, __LINE__, errmsg);
        return -2;
    }
    
    // 开始计时
    clock_t start = clock();
    
    // 开启事物
    if (sqlite3_exec(db, &quot;begin&quot;, NULL, NULL, &amp;errmsg) != SQLITE_OK) {
        printf(&quot;%4d Error:%sn&quot;, __LINE__, errmsg);
        return -2;
    }
    
    // 生成十万个大小在 边长在[0.002,0.202]度大小以内的数据(0.2~22.5公里左右)
    srand(time(NULL));  // 初始化随机数种子
    sqlite3_stmt *pStmt = NULL;
    
    // 预处理SQL语句
    if(sqlite3_prepare_v2(db,
                          &quot;INSERT INTO demo_index VALUES(?,?,?,?,?,?)&quot;,
                          -1, &amp;pStmt, NULL) != SQLITE_OK) {
        printf(&quot;%4d Error:%sn&quot;, __LINE__, errmsg);
        return -3;
    }
    // 逐个插入
    for (int i = 0; i &lt; 100000; ++i) {
        // 生成在经纬度范围内的x,y
        double x0 = ((double)rand() / (double)RAND_MAX) * 360 - 180;
        double y0 = ((double)rand() / (double)RAND_MAX) * 180 - 90;
        double x1 = x0 + 0.002 + ((double)rand() / (double)RAND_MAX)*0.2;
        double y1 = y0 + 0.002 + ((double)rand() / (double)RAND_MAX)*0.2;
        // 绑定数据
        sqlite3_bind_int64(pStmt, 1, i);
        sqlite3_bind_double(pStmt, 2, x0);
        sqlite3_bind_double(pStmt, 3, x1);
        sqlite3_bind_double(pStmt, 4, y0);
        sqlite3_bind_double(pStmt, 5, y1);
        sqlite3_bind_int(pStmt, 6, rand()%3);
        // 执行
        sqlite3_step(pStmt);
        // 重置
        sqlite3_reset(pStmt);
    }
    sqlite3_finalize(pStmt); //结束语句，释放语句句柄
    
    // 结束事物
    if (sqlite3_exec(db, &quot;commit&quot;, NULL, NULL, &amp;errmsg) != SQLITE_OK){
        printf(&quot;%4d Error:%sn&quot;, __LINE__, errmsg);
        return -2;
    }
    
    
    // 结束计时
    clock_t end = clock();
    double hs = (double)(end - start) * 1000 / CLOCKS_PER_SEC;
    printf(&quot;插入总耗时: %lf msn&quot;, hs);
    // 查询
    // select * from test where NOT(maxX&lt;74.254915 OR minX&gt;79.765758 OR maxY&lt; 24.214285 OR minY&gt;29.725129) AND auxcol==2 ORDER BY id;
    // 预处理SQL语句
    pStmt = NULL;
    if (sqlite3_prepare_v2(db,
            &quot;SELECT id,minX,minY,auxcol FROM demo_index WHERE NOT(maxX&lt;? OR minX&gt;? OR maxY&lt;?  OR minY&gt;?) AND auxcol==1;&quot;,
            -1, &amp;pStmt, NULL) != SQLITE_OK) {
        printf(&quot;%4d Error:%sn&quot;, __LINE__, errmsg);
        return -4;
    }
    
    //-------------------------------------------------------------------------
    
    // 输入查询的范围框数据
    puts(&quot;Input x0,x1,y0,y1:&quot;);
    double x0, x1, y0, y1;
    scanf(&quot;%lf,%lf,%lf,%lf&quot;, &amp;x0, &amp;x1, &amp;y0, &amp;y1);
    printf(&quot;-----------[%lf,%lf,%lf,%lf]-------------n&quot;, x0, x1, y0, y1);
    
    // 开始计时
    start = clock();
    
    // 绑定查询范围数据
    sqlite3_bind_double(pStmt, 1, x0);
    sqlite3_bind_double(pStmt, 2, x1);
    sqlite3_bind_double(pStmt, 3, y0);
    sqlite3_bind_double(pStmt, 4, y1);
    while (sqlite3_step(pStmt) == SQLITE_ROW) {
        int id = sqlite3_column_int(pStmt, 0);
        double x = sqlite3_column_double(pStmt, 1);
        double y = sqlite3_column_double(pStmt, 2);
        int auxcol = sqlite3_column_int(pStmt, 3);
        // 可以把输出去掉，减少对时间统计的影响
        printf(&quot;%dt %lf,%lfn&quot;, id, x, y);
    }
    sqlite3_reset(pStmt); // 这里只查询一次可以没有，如果需要多次使用这个查询语句，则必须有，不然查出数据不对
    sqlite3_finalize(pStmt); //结束语句，释放语句句柄
    
    // 结束计时
    end = clock();
    hs = (double)(end - start) * 1000 / CLOCKS_PER_SEC;
    printf(&quot;本次查询总耗时: %lf msn&quot;, hs);
    
    
    sqlite3_close(db);
    system(&quot;pause&quot;);
    return 0;
}
</code></pre>

        </div>
        <div class="sharing">







</div>
        



      </div>
    </div>

  </body>
  
</html>
