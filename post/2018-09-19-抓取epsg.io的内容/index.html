  <!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <title> 抓取epsg.io的内容 &middot; 风吹过 </title>
    
    <link rel="stylesheet" type="text/css" href="http://sotex.github.io/css/uno.min.css" />
    <link rel="stylesheet" type="text/css" href="http://sotex.github.io/css/lightGallery.css" />
    
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.ico">
    
    <link href="" rel="alternate" type="application/rss+xml" title="风吹过" />
    
    <script src="http://sotex.github.io/js/jquery.min.js"></script>
    <script src="http://sotex.github.io/js/main.min.js">
    </script>
</head>

  <body>
    <div id="scriptHeader">
    <span class="mobile btn-mobile-menu">
            <i class="fa fa-bars btn-mobile-menu__icon"></i>
            <i class="fa fa-times btn-mobile-close__icon hidden"> </i>
    </span>
    <header class="
        
            panel-cover panel-cover--collapsed
        " >
    <div class="panel-main">
        <div class="panel-main__inner panel-inverted">
            <div class="panel-main__content"> 
                <a href="http://sotex.github.io//" title="link to homepage for 风吹过"> <img src="/images/user.png" width="80" alt="风吹过 logo" class="panel-cover__logo logo" /> </a> 
                <h1 class="panel-cover__title panel-title">
                    <a href="http://sotex.github.io//"  title="link to homepage for 风吹过">风吹过</a>
                </h1>
                <hr class="panel-cover__divider" />
                <p class="panel-cover__description">  以前，晚餐后在学校田径场的大榕树下，散散步吹吹风，累了就去图书馆看看书，感觉真好。  </p>
                <hr class="panel-cover__divider panel-cover__divider--secondary" />
                <div class="navigation-wrapper">
                    <nav class="cover-navigation cover-navigation--primary">
                        <ul class="navigation">
                            <li class="navigation__item"><a href="http://sotex.github.io/#blog" title="查看 风吹过 博客" class="blog-button">博客</a> </li></br>
                            <li class="navigation__item"><a href="/pages/about.html" title="查看简介 " class="blog-button">简介</a> </li></br> 
                            
                       </ul>
                    </nav> <nav class="cover-navigation navigation--social">
    <ul class="navigation"> 
	
        
        <li class="navigation__item">
            <a href="http://cnblogs.com/oloroso" title="@oloroso 博客园"> <i class='fa fa-twitter'></i> <span class="label">cnblogs</span> </a>
        </li> 
	
	
        
        <li class="navigation__item">
            <a href="https://github.com/sotex" title="sotex on github"> <i class='fa fa-github'></i> <span class="label">Github</span> </a>
        </li>  </br>
	
	
	
        
        <li class="navigation__item">
            <a href="mailto:ymwh@foxmail.com" title="Email ymwh@foxmail.com"> <i class='fa fa-envelope-o'></i> <span class="label">Email</span> </a>
        </li>  </ul>
</nav>
 </div>
            </div>
        </div>
        <div class="panel-cover--overlay"></div>
    </div>
</header>
</div>
<noscript>
    <style>
        #scriptHeader {display:none;}
        .navigation-wrapper{
            display: block;
            top: 0;
        }
    </style>

    <header class="panel-cover panel-cover--collapsed" style="background-image: url()">
        <div class="panel-main">
            <div class="panel-main__inner panel-inverted">
                <div class="panel-main__content"> 
                    <a href="http://sotex.github.io//" title="link to homepage for 风吹过"> <img src="/images/user.png" width="80" alt="风吹过 logo" class="panel-cover__logo logo" /> </a> 
                    <h1 class="panel-cover__title panel-title">
                        <a href="http://sotex.github.io//"  title="link to homepage for 风吹过">风吹过</a>
                    </h1>
                    <hr class="panel-cover__divider" />
                    <p class="panel-cover__description">  以前，晚餐后在学校田径场的大榕树下，散散步吹吹风，累了就去图书馆看看书，感觉真好。  </p>
                    <hr class="panel-cover__divider panel-cover__divider--secondary" />
                    <div class="navigation-wrapper">
                        <nav class="cover-navigation cover-navigation--primary">
                            <ul class="navigation">
                                <li class="navigation__item"><a href="http://sotex.github.io//#blog" title="查看 风吹过 博客" class="blog-button">博客</a> </li></br>
                                <li class="navigation__item"><a href="/pages/about.html" title="查看简介" class="blog-button">简介</a> </li></br> 
                                
                           </ul>
                        </nav> <nav class="cover-navigation navigation--social">
    <ul class="navigation"> 
	
        
        <li class="navigation__item">
            <a href="http://cnblogs.com/oloroso" title="@oloroso 博客园"> <i class='fa fa-twitter'></i> <span class="label">cnblogs</span> </a>
        </li> 
	
	
        
        <li class="navigation__item">
            <a href="https://github.com/sotex" title="sotex on github"> <i class='fa fa-github'></i> <span class="label">Github</span> </a>
        </li>  </br>
	
	
	
        
        <li class="navigation__item">
            <a href="mailto:ymwh@foxmail.com" title="Email ymwh@foxmail.com"> <i class='fa fa-envelope-o'></i> <span class="label">Email</span> </a>
        </li>  </ul>
</nav>
 </div>
                </div>
            </div>
            <div class="panel-cover--overlay"></div>
        </div>
    </header>
</noscript>

    <div class="content-wrapper">
      <div class="content-wrapper__inner">
        <div class="post">
          <h1>抓取epsg.io的内容</h1>
          <span class="post-date">2018年09月19日</span>
          

<p>[TOC]
<a href="http://www.cnblogs.com/oloroso/archive/2018/09/19/9674716.html">博客园文章地址 http://www.cnblogs.com/oloroso/archive/2018/09/19/9674716.html</a></p>

<h1 id="简述">简述</h1>

<p><a href="http://epsg.io">epsg.io</a>是一个查询EPSG坐标系相关信息的好网站，内容很全。有各种格式的定义可以直接下载，也有坐标系的范围名称等相关信息，所以想抓取这些信息下来，方便对接各个系统。
<code>epsg.io</code>本身是开源的，代码在<a href="https://github.com/klokantech/epsg.io">https://github.com/klokantech/epsg.io</a>上，但是这个我分析出数据来源，应该是在<code>epsg.io/gml/gml.sqlite</code>文件中，但是我打开这个文件发现没有相关的记录。</p>

<h1 id="抓取说明">抓取说明</h1>

<p>抓取的时候使用的是<code>proj4</code>项目里的<code>nad/epsg</code>文件中的记录作为索引，找到对应的<code>epsg</code>代码去拼成对应<code>url</code>去下载。
下面是代码，用的是<code>libcurl</code>进行的相关操作。日志记录简单的用了一下<code>glog</code>，可以去掉，去掉之后就是纯C的代码了。
抓取的结果直接写在程序目录下的<code>epsg.io</code>目录下，请先创建好这个目录。
保存的<code>html</code>文件的解析，可以参考<a href="https://www.cnblogs.com/oloroso/p/9667642.html">HTML解析库Gumbo简单使用记录</a></p>

<p>抓取好的文件可以在这里<a href="https://files.cnblogs.com/files/oloroso/epsg.io.7z">epsg.io.7z</a>下载，解压压缩之后会有三百多兆，共5754个文件。
分析后提取的内容，生成了一个超大的JSON文件，可以再这里<a href="https://files.cnblogs.com/files/oloroso/epsg.io.json.7z">epsg.io.json.7z</a>下载。
<img src="https://img2018.cnblogs.com/blog/693958/201809/693958-20180919215335705-674123821.jpg" alt="" /></p>

<hr />

<p>我把抓取的内容处理成json后，又将其导入了<code>MongoDB</code>数据库。
这里将数据备份后上传在这里<a href="https://files.cnblogs.com/files/oloroso/epsg.io.mongodb.7z">https://files.cnblogs.com/files/oloroso/epsg.io.mongodb.7z</a>，这个数据可以直接使用<code>mongorestore</code>工具恢复到数据库。
<strong>导入MongoDB的数据中，<code>wgs84_bound</code>字段名改为<code>84box</code>，<code>proj_bound</code>字段改为<code>projbox</code>，中心点坐标经过处理，不会有<code>null</code>出现。</strong></p>

<h1 id="代码">代码</h1>

<pre><code class="language-cpp">// g++ epsg.spider.cpp -o epsg.spider -lcurl  -lglog -lpthread
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;curl/curl.h&gt;
#include &lt;glog/logging.h&gt;


int downpage(int epsgcode)
{
	int ret = 0;
	char url[1024];
	sprintf(url,&quot;./epsg.io/%d.html&quot;,epsgcode);
	FILE* fp = fopen(url,&quot;wb&quot;);
	if(fp == NULL){
		fprintf(stderr,&quot;\n创建输出文件失败i\n&quot;);
		ret = -1;
		return ret;
	}

	sprintf(url,&quot;http://epsg.io/%d&quot;,epsgcode);
	CURL *hnd = curl_easy_init();
	curl_easy_setopt(hnd, CURLOPT_CUSTOMREQUEST, &quot;GET&quot;);
	curl_easy_setopt(hnd, CURLOPT_URL, url);
	curl_easy_setopt(hnd, CURLOPT_COOKIEFILE, &quot;./epsg.spider.cookie&quot;);
	//curl_easy_setopt(hnd, CURLOPT_COOKIE, cookie_buffer);

	curl_easy_setopt(hnd, CURLOPT_WRITEDATA, fp);

	CURLcode res = (CURLcode)curl_easy_perform(hnd);
	if(res != CURLE_OK) {
		fprintf(stderr,&quot;\n%s curl_easy_perform failed:%s\n&quot;,url,curl_easy_strerror(res));
		ret = -2;
	}
	fclose(fp);
	curl_easy_cleanup(hnd);
	return ret;
}

int main(int c,char** v)
{
       // 打开epsg文件
	FILE* fp = fopen(&quot;epsg&quot;,&quot;r&quot;);
	if(fp == NULL){ 
		puts(&quot;open epsg fiaild&quot;);
		return 0;
	}
	google::InitGoogleLogging(v[0]);
	FLAGS_log_dir = &quot;.&quot;;
 
	  /*
	   * 这个函数只能用一次,如果这个函数在curl_easy_init函数调用时还没调用，
	   * 它讲由libcurl库自动调用，所以多线程下最好在主线程中调用一次该函数以防止在线程
	   * 中curl_easy_init时多次调用
	   */
	  curl_global_init(CURL_GLOBAL_ALL);

	char s[4096];

	puts(&quot;开始下载:&quot;);
	while(!feof(fp) &amp;&amp; limit &gt; 0){
		int epsgcode = 0;
		static char name[1024];
		static char proj[1024];
		fgets(s,sizeof s,fp);
		if(s[0] == '#' ){
			sscanf(s,&quot;# %[^\n]s&quot;,name);
		}
		sscanf(s,&quot;&lt;%d&gt; %[^\n&lt;]s&quot;,&amp;epsgcode,proj);
		if(epsgcode == 0){
			continue;
		}
		char path[128];
		sprintf(path,&quot;./epsg.io/%d.html&quot;,epsgcode);
		struct stat st;
		if(stat(path,&amp;st) == 0) {
			if(st.st_size &gt; 1024){
				// printf(&quot;%5d   %s exsits\n&quot;,epsgcode,path);
				continue;
			}
		}

		printf(&quot;\r正在下载:http://epsg.io/%d &quot;,epsgcode);
		LOG(INFO) &lt;&lt; &quot;begin download http://epsg.io/&quot;&lt;&lt;epsgcode;
		if( downpage(epsgcode) != 0){
			break;
		}
		LOG(INFO) &lt;&lt; &quot;finish download http://epsg.io/&quot;&lt;&lt;epsgcode;
	}

	//在结束libcurl使用的时候，用来对curl_global_init做的工作清理。类似于close的函数
	curl_global_cleanup();

	fclose(fp);
	return 0;
}
</code></pre>

        </div>
        <div class="sharing">







</div>
        



      </div>
    </div>

  </body>
  
</html>
