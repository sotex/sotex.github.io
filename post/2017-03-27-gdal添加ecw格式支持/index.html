  <!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <title> GDAL添加ECW格式支持 &middot; 风吹过 </title>
    
    <link rel="stylesheet" type="text/css" href="http://sotex.github.io//css/uno.min.css" />
    <link rel="stylesheet" type="text/css" href="http://sotex.github.io//css/lightGallery.css" />
    
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.ico">
    
    <link href="" rel="alternate" type="application/rss+xml" title="风吹过" />
    
    <script src="http://sotex.github.io//js/jquery.min.js"></script>
    <script src="http://sotex.github.io//js/main.min.js">
    </script>
</head>

  <body>
    <div id="scriptHeader">
    <span class="mobile btn-mobile-menu">
            <i class="fa fa-bars btn-mobile-menu__icon"></i>
            <i class="fa fa-times btn-mobile-close__icon hidden"> </i>
    </span>
    <header class="
        
            panel-cover panel-cover--collapsed
        " >
    <div class="panel-main">
        <div class="panel-main__inner panel-inverted">
            <div class="panel-main__content"> 
                <a href="http://sotex.github.io//" title="link to homepage for 风吹过"> <img src="/images/user.png" width="80" alt="风吹过 logo" class="panel-cover__logo logo" /> </a> 
                <h1 class="panel-cover__title panel-title">
                    <a href="http://sotex.github.io//"  title="link to homepage for 风吹过">风吹过</a>
                </h1>
                <hr class="panel-cover__divider" />
                <p class="panel-cover__description">  以前，晚餐后在学校田径场的大榕树下，散散步吹吹风，累了就去图书馆看看书，感觉真好。  </p>
                <hr class="panel-cover__divider panel-cover__divider--secondary" />
                <div class="navigation-wrapper">
                    <nav class="cover-navigation cover-navigation--primary">
                        <ul class="navigation">
                            <li class="navigation__item"><a href="http://sotex.github.io/#blog" title="查看 风吹过 博客" class="blog-button">博客</a> </li></br>
                            <li class="navigation__item"><a href="/pages/about.html" title="查看简介 " class="blog-button">简介</a> </li></br> 
                            
                       </ul>
                    </nav> <nav class="cover-navigation navigation--social">
    <ul class="navigation"> 
	
        
        <li class="navigation__item">
            <a href="http://cnblogs.com/oloroso" title="@oloroso 博客园"> <i class='fa fa-twitter'></i> <span class="label">cnblogs</span> </a>
        </li> 
	
	
        
        <li class="navigation__item">
            <a href="https://github.com/sotex" title="sotex on github"> <i class='fa fa-github'></i> <span class="label">Github</span> </a>
        </li>  </br>
	
	
	
        
        <li class="navigation__item">
            <a href="mailto:ymwh@foxmail.com" title="Email ymwh@foxmail.com"> <i class='fa fa-envelope-o'></i> <span class="label">Email</span> </a>
        </li>  </ul>
</nav>
 </div>
            </div>
        </div>
        <div class="panel-cover--overlay"></div>
    </div>
</header>
</div>
<noscript>
    <style>
        #scriptHeader {display:none;}
        .navigation-wrapper{
            display: block;
            top: 0;
        }
    </style>

    <header class="panel-cover panel-cover--collapsed" style="background-image: url()">
        <div class="panel-main">
            <div class="panel-main__inner panel-inverted">
                <div class="panel-main__content"> 
                    <a href="http://sotex.github.io//" title="link to homepage for 风吹过"> <img src="/images/user.png" width="80" alt="风吹过 logo" class="panel-cover__logo logo" /> </a> 
                    <h1 class="panel-cover__title panel-title">
                        <a href="http://sotex.github.io//"  title="link to homepage for 风吹过">风吹过</a>
                    </h1>
                    <hr class="panel-cover__divider" />
                    <p class="panel-cover__description">  以前，晚餐后在学校田径场的大榕树下，散散步吹吹风，累了就去图书馆看看书，感觉真好。  </p>
                    <hr class="panel-cover__divider panel-cover__divider--secondary" />
                    <div class="navigation-wrapper">
                        <nav class="cover-navigation cover-navigation--primary">
                            <ul class="navigation">
                                <li class="navigation__item"><a href="http://sotex.github.io//#blog" title="查看 风吹过 博客" class="blog-button">博客</a> </li></br>
                                <li class="navigation__item"><a href="/pages/about.html" title="查看简介" class="blog-button">简介</a> </li></br> 
                                
                           </ul>
                        </nav> <nav class="cover-navigation navigation--social">
    <ul class="navigation"> 
	
        
        <li class="navigation__item">
            <a href="http://cnblogs.com/oloroso" title="@oloroso 博客园"> <i class='fa fa-twitter'></i> <span class="label">cnblogs</span> </a>
        </li> 
	
	
        
        <li class="navigation__item">
            <a href="https://github.com/sotex" title="sotex on github"> <i class='fa fa-github'></i> <span class="label">Github</span> </a>
        </li>  </br>
	
	
	
        
        <li class="navigation__item">
            <a href="mailto:ymwh@foxmail.com" title="Email ymwh@foxmail.com"> <i class='fa fa-envelope-o'></i> <span class="label">Email</span> </a>
        </li>  </ul>
</nav>
 </div>
                </div>
            </div>
            <div class="panel-cover--overlay"></div>
        </div>
    </header>
</noscript>

    <div class="content-wrapper">
      <div class="content-wrapper__inner">
        <div class="post">
          <h1>GDAL添加ECW格式支持</h1>
          <span class="post-date">2017年03月27日</span>
          

<p>[TOC]
<a href="http://www.cnblogs.com/oloroso/archive/2017/03/27/6625669.html">博客园原文地址 http://www.cnblogs.com/oloroso/archive/2017/03/27/6625669.html</a></p>

<h1 id="gdal添加ecw格式支持">GDAL添加ECW格式支持</h1>

<p>本文翻译自 <a href="http://trac.osgeo.org/gdal/wiki/ECW">http://trac.osgeo.org/gdal/wiki/ECW</a>，有少量的修改及补充。</p>

<h2 id="ecw">ECW</h2>

<p>这个驱动程序的最终用户文档:<a href="​http://www.gdal.org/frmt_ecw.html">​http://www.gdal.org/frmt_ecw.html</a></p>

<h2 id="下载ecw-jpeg-sdk">下载ECW JPEG SDK</h2>

<p>为了让GDAL可以使用ECW格式，你需要从<a href="http://download.hexagongeospatial.com/download-portal?ProductName=336677bc-d93b-6e30-89b7-ff00003c6ea8">Hexagon Geospatial</a>网站下载<code>ERDAS ECW/JP2 SDK</code>。
<code>4.3</code>或更高版本的<code>只读SDK</code>(不支持写ECW文件)需要在同意许可条款后免费下载。如果要通过<code>ECW SDK</code>写<code>ECW</code>或<code>JPEG2000</code>文件，必须从<a href="http://download.hexagongeospatial.com">Hexagon Geospatial/ERDAS</a>购买可写版本的SDK.</p>

<p>如果可以找到过期的<code>libecwj 3.3 SDK</code>，也可以使用它。它的许可信息有显著不同。下面的叙述和讨论基于<code>3.3 SDK</code>。</p>

<h2 id="在unix平台构建支持ecw的gdal">在Unix平台构建支持ECW的GDAL</h2>

<p>假设您已经在默认位置(<code>LIBRARY_PATH</code>)安装了<code>libecwj</code>库，那么将<code>ECW</code>支持添加到<code>GDAL</code>的过程很简单。
只需要在生成编译<code>GDAL</code>的<code>Makefile</code>的<code>configure</code>命令中添加<code>ecw</code>库的安装路径：</p>

<pre><code class="language-bash">$ cd /path/to/gdal
$ ./configure --with-ecw=/usr/local
$ make
# make install
</code></pre>

<p>如果在构建中存在问题，可以查看<code>gdal/frmts/ecw/GNUmakefile</code>中的<code>CPPFLAGS</code>是否定义了<code>-DPOSIX</code>和<code>-DLINUX</code>。参考<a href="http://trac.osgeo.org/gdal/ticket/3344">#3344</a></p>

<p>在完成上面步骤后，可以查看GDAL已安装支持格式列表，可以看到有<code>ECW</code>:</p>

<pre><code class="language-bash">$ gdalinfo --formats|grep ECW
  ECW (rw): ERMapper Compressed Wavelets
  JP2ECW (rw+): ERMapper JPEG2000
</code></pre>

<p><strong>注意:</strong>所有依赖<code>GDAL</code>的服务都应该重启。例如：<code>Apache</code>需要重新加载<code>PHP MapScript</code>。</p>

<h2 id="二进制ecw-sdk和gcc-5-1">二进制ECW SDK和GCC &gt;= 5.1</h2>

<p>由于<code>GCC 5.1</code>以后，GCC默认使用新的<code>C++ ABI</code>和<code>libstdc++</code>，它与<code>ECW SDK</code>二进制文件不兼容（至少当前如此）。解决的办法是使用<code>CXXFLAGS=&quot;-D_GLIBCXX_USE_CXX11_ABI=0&quot;</code>选项去构建<code>GDAL</code>。</p>

<pre><code class="language-bash">./configure CXXFLAGS=&quot;-D_GLIBCXX_USE_CXX11_ABI=0&quot;
</code></pre>

<p><strong>注意:</strong>如果你还使用别的使用新的<code>C++ ABI</code>的库（例如：likbml，podofo，poppler，cryptopp等，这通常来自发行版自带的），则这个方法无法正常使用。如果你必须使用这些库，你必须找到它们的源码，并使用<code>CXXFLAGS=&quot;-D_GLIBCXX_USE_CXX11_ABI=0&quot;</code>选项重新编译。</p>

<h3 id="在linux上构建的教程">在Linux上构建的教程</h3>

<p><a href="http://trac.osgeo.org/ubuntugis/wiki/UserTutorials">​http://trac.osgeo.org/ubuntugis/wiki/UserTutorials</a></p>

<h2 id="在windows上构建支持ecw的gdal">在Windows上构建支持ECW的GDAL</h2>

<p>在<code>nmake.opt</code>中有以下使用4.1或更新的只读SDK构建读取支持的选项，去掉前面的注释，并修改<code>ECWDIR</code>只想的路径。</p>

<pre><code class="language-bash"># Uncomment the following and update to enable ECW read support with the 
# 4.1+ readonly SDK
#ECWDIR  = 	&quot;c:/Program Files/ERDAS/ERDAS ECW JPEG2000 Read SDK&quot;
#ECWFLAGS =	-DECWSDK_VERSION=41 \
#		-I$(ECWDIR)\include \
#		-I$(ECWDIR)\include/ecw/api -I$(ECWDIR)\include/ecw/jp2 \
#		-I$(ECWDIR)\include/ecw/ecw
#ECWLIB  = 	$(ECWDIR)\lib\vc90\win32\NCSEcw4_RO.lib \
#		$(ECWDIR)\lib\vc90\win32\NCSUtil4.lib \
#		$(ECWDIR)\lib\vc90\win32\NCScnet4.lib
</code></pre>

<p>GDAL自带的<code>nmake.opt</code>还是默认的VS2008，比较老了。
实际上现在nmake.opt里面有两处关于ECWSDK的位置，最新版本的ECWSDK5需使用链接<code>NCSEcw.lib</code>或者静态库<code>NCSEcwS.lib</code>的即可。如果编译<code>64位版本，还需要去掉</code>WIN64=YES<code>前的</code>#<code>，大致在</code>189<code>行。
例如在使用</code>VS2015`编译的时候，修改的位置及结果如下：</p>

<pre><code class="language-bash"># 45行位置，修改编译器版本
MSVC_VER=1900

# 189行位置，编译64位版本
WIN64=YES

# 303行位置，修改libecwj路径
ECWDIR  = 	&quot;c:/Program Files/ERDAS ECW JPEG 2000 SDK 5.3.0&quot;
ECWFLAGS =	-DECWSDK_VERSION=53 \
		-I$(ECWDIR)\include \
		-I$(ECWDIR)\include/NCSECW/API -I$(ECWDIR)\include/NCSECW/JP2 \
		-I$(ECWDIR)\include/NCSECW/ECW
ECWLIB  = 	$(ECWDIR)\lib\VC140\x64\NCSEcw.lib
</code></pre>

<p>一旦构建，则需要将一些ECW的dll拷贝到系统路径(程序工作目录也可)中(VC9环境下如下)</p>

<pre><code class="language-bash">copy &quot;C:\Program Files\ERDAS\ERDAS ECW JPEG2000 Read SDK\redistributable\vc90\win32\*.dll&quot; C:\windows\system32
</code></pre>

<p><strong>当前最新版本的为<code>ECW JPEG 2000 SDK 5.3.0</code>，使用VC11/12/14编译。</strong></p>

<p>以上将ECW的支持构建到<code>GDAL核心DLL</code>中。</p>

<p>为了构建ECW和JP2ECW驱动程序<strong>作为插件</strong>，需要取消<code>nmake.opt</code>中注释的插件行：</p>

<pre><code class="language-bash"># To build ECW support as a plugin uncomment the following, and make sure
# to do &quot;nmake /f makefile.vc plugin&quot; in gdal/frmts/ecw and copy the two
# resulting DLLs to an appropriate place.
ECW_PLUGIN = YES
</code></pre>

<p>然后到<code>gdal/frmts/ecw</code>(在GDAL构建后)中去<strong>创建插件plugins</strong>:</p>

<pre><code class="language-bash">  nmake /f makefile.vc plugin
</code></pre>

<p>然后将该目录中生成的<code>dll</code>复制到合适的<code>GDAL</code>插件目录，例如<code>.exe</code>文件所在目录下的<code>gdalplugins</code>目录中，或着是<code>GDAL_DRIVER_PATH</code>配置选项(或环境变量)指向的目录。</p>

<h2 id="在unix上构建libecwj-3-3库">在Unix上构建libecwj 3.3库</h2>

<p>为了在<code>Linux</code><code>Solaris</code>或<code>Mac OS</code>系统下使用<code>具有ECW支持</code>的<code>GDAL</code>，您需要自己构建<code>libecwj</code>库，因此需要下载<code>Image Compression SDK</code>源代码，而不是专门为Windows系统分发的二进制文件。当前版本是<code>ECW SDK 3.3</code>，源码包名为<code>libecwj2-3.3-2006-09-06.zip</code>。</p>

<p>源码包中有<code>configure</code>和<code>Makefile.in</code>脚本，还有一个<code>bootstrap</code>脚本，可以重新生成<code>configure</code>和<code>Makefile.in</code>文件。请先确保已经安装了:<code>autoconf</code>, <code>automake</code>, <code>m4</code>, <code>libtool</code>程序。</p>

<p>程序的构建示例如下：</p>

<pre><code class="language-bash">$ cd /path/to/libecwj2-3.3
$ ./configure
$ make
# make install
</code></pre>

<p>上面配置没有指定安装路径，最后一步需要<code>superuser</code>权限。</p>

<p>在SuSE 11(低版本gcc),你需要传递一个<code>flag</code>给<code>configure</code>脚本去使用<code>c99</code>兼容性。</p>

<pre><code class="language-bash">$ cd /path/to/libecwj2-3.3
$ ./configure CFLAGS=&quot;-std=c99&quot;
$ make
# make install
</code></pre>

<p>默认情况下，安装时使用<code>prefix</code>指向目录<code>/usr/local</code>来安装<code>libecwj</code>。你可以使用<code>configure</code>的<code>--prefix</code>选项指定。运行<code>configure --help</code>查看更多选项。如果编译<code>libecwj</code>使用了<code>--prefix</code>(例如<code>/usr/local/libecwj2-3.3</code>)，则<code>make install</code>会失败，因为不会自动创建<code>&lt;prefix&gt;/include</code>。执行<code>mkdir &lt;prefix&gt;/include</code>(例如<code>mkdir /usr/local/libecwj2-3.3/include</code>)，然后再次运行<code>make install</code>。</p>

<p>在较新的平台(Fedora 16/17/18和RHEL/CentOS 6)上，<code>libecwj2</code>可以在读取<code>JPEG2000</code>文件时会导致程序崩溃。错误在与<code>libecwj2</code>绑定的<code>XML</code>处理代码中，显而易见，这是新的编译器带来的问题。上述平台的一个解决办法是在编译<code>libecwj2</code>时禁用优化，可以通过传递<code>-O0</code>来配置：</p>

<pre><code class="language-bash">$ ./configure CFLAGS=&quot;-O0&quot; CXXFLAGS=&quot;-O0&quot;
</code></pre>

<p>或者在make时候指定:</p>

<pre><code class="language-bash">$ make CFLAGS=&quot;-O0&quot; CXXFLAGS=&quot;-O0&quot;
</code></pre>

<h3 id="mac-os-x-notes">Mac OS X notes</h3>

<p>在Mac OS X上构建<code>libecwj2-3.3</code>可能会有一点问题。相关详细信息，参阅<a href="http://trac.osgeo.org/gdal/ticket/2032"><del>#2032</del></a>。</p>

<h2 id="libecwj2-3-3-补丁">libecwj2-3.3 补丁</h2>

<p>使用最新的编译器从源码构建<code>libecwj2-3.3</code>可能需要一些改进，可以在<a href="http://trac.osgeo.org/gdal/ticket/3162"><del>#3162</del></a>中找到<code>libecwj2</code>的修复程序和补丁程序中找到。</p>

<p>综合累积可用补丁：
<a href="https://trac.osgeo.org/gdal/attachment/wiki/ECW/libecwj2-3.3.patch">https://trac.osgeo.org/gdal/attachment/wiki/ECW/libecwj2-3.3.patch</a></p>

<p>使用<code>libecwj2-3.3</code>打开和关闭<code>ECW</code>文件占用大量内存的问题，可以使用<a href="http://trac.osgeo.org/mapserver/ticket/3245">http://trac.osgeo.org/mapserver/ticket/3245</a>补丁来解决。</p>

<p><a href="http://trac.osgeo.org/gdal/ticket/3366"><del>#3366</del></a>中提供了一个补丁，来避免在<code>libecwj2-3.3</code>中的<code>NCSPhysicalMemorySize()</code>的<code>linux</code>实现中溢出。这个工作可以解决内存大于<code>2G</code>的计算机中大内存使用情况。</p>

<p>A patch to fix crash when creating 16 bit JP2 (that occurs on 64bit platforms) is available in ticket <a href="http://trac.osgeo.org/gdal/ticket/2593"><del>#2593</del></a>中提供了修复<code>16 bit JP2</code>(在64为平台发生)时出现故障的补丁。</p>

<p>在最新的平台(如Fedora 17，使用GCC 4.7)上修复<code>ECWInitialize()</code>崩溃的补丁程序可在<a href="http://trac.osgeo.org/gdal/ticket/4868"><del>#4868</del></a>中找到。</p>

<p>##Open Tickets</p>

<p><a href="http://trac.osgeo.org/gdal/ticket/2162">#2162</a> ecw_cs.dat文件出自多云天(provenance cloudy)
<a href="http://trac.osgeo.org/gdal/ticket/2340">#2340</a> 意大利基准(italian datum)问题。
<a href="http://trac.osgeo.org/gdal/ticket/4127">#4127</a> [PATCH] ECW文件<code>ecw_cs.wkt</code>附加<code>CRS</code>定义。</p>

        </div>
        <div class="sharing">







</div>
        



      </div>
    </div>

  </body>
  
</html>
