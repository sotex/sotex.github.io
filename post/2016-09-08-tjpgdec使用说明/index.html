  <!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <title> TJpgDec使用说明 &middot; 风吹过 </title>
    
    <link rel="stylesheet" type="text/css" href="http://sotex.github.io/css/uno.min.css" />
    <link rel="stylesheet" type="text/css" href="http://sotex.github.io/css/lightGallery.css" />
    
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.ico">
    
    <link href="" rel="alternate" type="application/rss+xml" title="风吹过" />
    
    <script src="http://sotex.github.io/js/jquery.min.js"></script>
    <script src="http://sotex.github.io/js/main.min.js">
    </script>
</head>

  <body>
    <div id="scriptHeader">
    <span class="mobile btn-mobile-menu">
            <i class="fa fa-bars btn-mobile-menu__icon"></i>
            <i class="fa fa-times btn-mobile-close__icon hidden"> </i>
    </span>
    <header class="
        
            panel-cover panel-cover--collapsed
        " >
    <div class="panel-main">
        <div class="panel-main__inner panel-inverted">
            <div class="panel-main__content"> 
                <a href="http://sotex.github.io//" title="link to homepage for 风吹过"> <img src="/images/user.png" width="80" alt="风吹过 logo" class="panel-cover__logo logo" /> </a> 
                <h1 class="panel-cover__title panel-title">
                    <a href="http://sotex.github.io//"  title="link to homepage for 风吹过">风吹过</a>
                </h1>
                <hr class="panel-cover__divider" />
                <p class="panel-cover__description">  以前，晚餐后在学校田径场的大榕树下，散散步吹吹风，累了就去图书馆看看书，感觉真好。  </p>
                <hr class="panel-cover__divider panel-cover__divider--secondary" />
                <div class="navigation-wrapper">
                    <nav class="cover-navigation cover-navigation--primary">
                        <ul class="navigation">
                            <li class="navigation__item"><a href="http://sotex.github.io/#blog" title="查看 风吹过 博客" class="blog-button">博客</a> </li></br>
                            <li class="navigation__item"><a href="/pages/about.html" title="查看简介 " class="blog-button">简介</a> </li></br> 
                            
                       </ul>
                    </nav> <nav class="cover-navigation navigation--social">
    <ul class="navigation"> 
	
        
        <li class="navigation__item">
            <a href="http://cnblogs.com/oloroso" title="@oloroso 博客园"> <i class='fa fa-twitter'></i> <span class="label">cnblogs</span> </a>
        </li> 
	
	
        
        <li class="navigation__item">
            <a href="https://github.com/sotex" title="sotex on github"> <i class='fa fa-github'></i> <span class="label">Github</span> </a>
        </li>  </br>
	
	
	
        
        <li class="navigation__item">
            <a href="mailto:ymwh@foxmail.com" title="Email ymwh@foxmail.com"> <i class='fa fa-envelope-o'></i> <span class="label">Email</span> </a>
        </li>  </ul>
</nav>
 </div>
            </div>
        </div>
        <div class="panel-cover--overlay"></div>
    </div>
</header>
</div>
<noscript>
    <style>
        #scriptHeader {display:none;}
        .navigation-wrapper{
            display: block;
            top: 0;
        }
    </style>

    <header class="panel-cover panel-cover--collapsed" style="background-image: url()">
        <div class="panel-main">
            <div class="panel-main__inner panel-inverted">
                <div class="panel-main__content"> 
                    <a href="http://sotex.github.io//" title="link to homepage for 风吹过"> <img src="/images/user.png" width="80" alt="风吹过 logo" class="panel-cover__logo logo" /> </a> 
                    <h1 class="panel-cover__title panel-title">
                        <a href="http://sotex.github.io//"  title="link to homepage for 风吹过">风吹过</a>
                    </h1>
                    <hr class="panel-cover__divider" />
                    <p class="panel-cover__description">  以前，晚餐后在学校田径场的大榕树下，散散步吹吹风，累了就去图书馆看看书，感觉真好。  </p>
                    <hr class="panel-cover__divider panel-cover__divider--secondary" />
                    <div class="navigation-wrapper">
                        <nav class="cover-navigation cover-navigation--primary">
                            <ul class="navigation">
                                <li class="navigation__item"><a href="http://sotex.github.io//#blog" title="查看 风吹过 博客" class="blog-button">博客</a> </li></br>
                                <li class="navigation__item"><a href="/pages/about.html" title="查看简介" class="blog-button">简介</a> </li></br> 
                                
                           </ul>
                        </nav> <nav class="cover-navigation navigation--social">
    <ul class="navigation"> 
	
        
        <li class="navigation__item">
            <a href="http://cnblogs.com/oloroso" title="@oloroso 博客园"> <i class='fa fa-twitter'></i> <span class="label">cnblogs</span> </a>
        </li> 
	
	
        
        <li class="navigation__item">
            <a href="https://github.com/sotex" title="sotex on github"> <i class='fa fa-github'></i> <span class="label">Github</span> </a>
        </li>  </br>
	
	
	
        
        <li class="navigation__item">
            <a href="mailto:ymwh@foxmail.com" title="Email ymwh@foxmail.com"> <i class='fa fa-envelope-o'></i> <span class="label">Email</span> </a>
        </li>  </ul>
</nav>
 </div>
                </div>
            </div>
            <div class="panel-cover--overlay"></div>
        </div>
    </header>
</noscript>

    <div class="content-wrapper">
      <div class="content-wrapper__inner">
        <div class="post">
          <h1>TJpgDec使用说明</h1>
          <span class="post-date">2016年09月08日</span>
          <p>#TJpgDec模块应用说明</p>

<p>[TOC]
<a href="http://www.cnblogs.com/oloroso/archive/2016/09/08/5852235.html">博客园原文地址 http://www.cnblogs.com/oloroso/archive/2016/09/08/5852235.html</a></p>

<p>##怎么使用</p>

<p>首先，你应该构建和运行如下所示示例程序。这是一个典型的使用<code>TJpgDec</code>模块，它有助于调试和缩小问题。</p>

<p>解码会话分为两个阶段。第一阶段是分析JPEG图像，第二阶段是解码。</p>

<ol>
<li>初始化输入流。(例如:打开一个文件)</li>
<li>分配JPEG解码对象和工作区域。</li>
<li>调用<code>jd_prepare</code>取分析和准备压缩的JPEG图像。</li>
<li>使用解码对象中的图像信息初始化输出设备。</li>
<li>调用<code>jd_decomp</code>解码JPEG图像。</li>
</ol>

<p>##系统结构</p>

<p><img src="http://images2015.cnblogs.com/blog/693958/201609/693958-20160908105708691-1033832576.png" alt="TJpgDec系统结构" /></p>

<p>##示例</p>

<pre><code class="language-c">/*------------------------------------------------*/
/* TJpgDec Quick Evaluation Program for PCs       */
/*------------------------------------------------*/

#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include &quot;tjpgd.h&quot;


/* 用户定义设备标识 */
typedef struct {
    FILE *fp;      /* 用于输入函数的文件指针 */
    BYTE *fbuf;    /* 用于输出函数的帧缓冲区的指针 */
    UINT wfbuf;    /* 帧缓冲区的图像宽度[像素] */
} IODEV;


/*------------------------------*/
/*      用户定义input funciton  */
/*------------------------------*/

UINT in_func (JDEC* jd, BYTE* buff, UINT nbyte)
{
    IODEV *dev = (IODEV*)jd-&gt;device;   /* Device identifier for the session (5th argument of jd_prepare function) */


    if (buff) {
        /* 从输入流读取一字节 */
        return (UINT)fread(buff, 1, nbyte, dev-&gt;fp);
    } else {
        /* 从输入流移除一字节 */
        return fseek(dev-&gt;fp, nbyte, SEEK_CUR) ? 0 : nbyte;
    }
}


/*------------------------------*/
/*      用户定义output funciton */
/*------------------------------*/

UINT out_func (JDEC* jd, void* bitmap, JRECT* rect)
{
    IODEV *dev = (IODEV*)jd-&gt;device;
    BYTE *src, *dst;
    UINT y, bws, bwd;


    /* 输出进度 */
    if (rect-&gt;left == 0) {
        printf(&quot;\r%lu%%&quot;, (rect-&gt;top &lt;&lt; jd-&gt;scale) * 100UL / jd-&gt;height);
    }

    /* 拷贝解码的RGB矩形范围到帧缓冲区(假设RGB888配置) */
    src = (BYTE*)bitmap;
    dst = dev-&gt;fbuf + 3 * (rect-&gt;top * dev-&gt;wfbuf + rect-&gt;left);  /* 目标矩形的左上 */
    bws = 3 * (rect-&gt;right - rect-&gt;left + 1);     /* 源矩形的宽度[字节] */
    bwd = 3 * dev-&gt;wfbuf;                         /* 帧缓冲区宽度[字节] */
    for (y = rect-&gt;top; y &lt;= rect-&gt;bottom; y++) {
        memcpy(dst, src, bws);   /* 拷贝一行 */
        src += bws; dst += bwd;  /* 定位下一行 */
    }

    return 1;    /* 继续解码 */
}


/*------------------------------*/
/*        主程序                */
/*------------------------------*/

int main (int argc, char* argv[])
{
    void *work;       /* 指向解码工作区域 */
    JDEC jdec;        /* 解码对象 */
    JRESULT res;      /* TJpgDec API的返回值 */
    IODEV devid;      /* 用户定义设备标识 */

    /* 打开一个JPEG文件 */
    if (argc &lt; 2) return -1;
    devid.fp = fopen(argv[1], &quot;rb&quot;);
    if (!devid.fp) return -1;

    /* 分配一个用于TJpgDec的工作区域 */
    work = malloc(3100);

    /* 准备解码 */
    res = jd_prepare(&amp;jdec, in_func, work, 3100, &amp;devid);
    if (res == JDR_OK) {
        /* 准备好解码。图像信息有效 */
        printf(&quot;Image dimensions: %u by %u. %u bytes used.\n&quot;, jdec.width, jdec.height, 3100 - jdec.sz_pool);

        devid.fbuf = malloc(3 * jdec.width * jdec.height); /* 输出图像的帧缓冲区(假设RGB888配置) */
        devid.wfbuf = jdec.width;

        res = jd_decomp(&amp;jdec, out_func, 0);   /* 开始1/1缩放解码 */
        if (res == JDR_OK) {
            /* 解码成功。你在这里已经解码图像到帧缓冲区 */
            printf(&quot;\rOK  \n&quot;);

        } else {
            printf(&quot;Failed to decompress: rc=%d\n&quot;, res);
        }

        free(devid.fbuf);    /* 释放帧缓冲区 */

    } else {
        printf(&quot;Failed to prepare: rc=%d\n&quot;, res);
    }

    free(work);             /* 释放工作区域 */

    fclose(devid.fp);       /* 关闭JPEG文件 */

    return res;
}
</code></pre>

<p>##限制</p>

<ul>
<li>JPEG标准：仅基线。渐进和无损JPEG格式不支持。</li>
<li>图像大小：最大<code>65520 x 65520</code>像素。</li>
<li>颜色空间：仅<code>YCbCr</code>三通道。灰度图像不支持。</li>
<li>采样因子：<code>4:4:4</code>、<code>4:2:2</code>或<code>4:2:0</code>。</li>
</ul>

<p>##内存使用</p>

<p>这是一些平台在默认配置下的内存占用。编译优化的代码大小。</p>

<table>
<thead>
<tr>
<th>AVR</th>
<th>PIC24</th>
<th>CM0</th>
<th>IA-32</th>
</tr>
</thead>

<tbody>
<tr>
<td>编译器</td>
<td>GCC</td>
<td>C30</td>
<td>GCC</td>
</tr>

<tr>
<td>程序大小</td>
<td>9422</td>
<td>6544</td>
<td>4536</td>
</tr>
</tbody>
</table>

<p>至于工作区，TJpgDec至多需要3100字节用于JPEG图像。这完全取决于什么样的参数被用来创建JPEG图像。3100字节是在默认输入缓存(JD_SZBUF == 512)下的最大内存需求，并随<code>JD_SZBUF</code>变化。<code>JD_SZBUF</code>定义每次从输入流中读取多少字节。<code>TJpgDec</code>对齐每个读请求缓冲区大小，512, 1024, 2048&hellip; 字节是从存储设备读取的理想大小。</p>

<p>##关于TJpgDec许可</p>

<p>这是一份包含在源代码TJpgDec许可文件。</p>

<pre><code class="language-c">/*----------------------------------------------------------------------------/
/ TJpgDec - Tiny JPEG Decompressor R0.01                       (C)ChaN, 2011
/-----------------------------------------------------------------------------/
/ The TJpgDec is a generic JPEG decompressor module for tiny embedded systems.
/ This is a free software that opened for education, research and commercial
/  developments under license policy of following terms.
/
/  Copyright (C) 2011, ChaN, all right reserved.
/
/ * The TJpgDec module is a free software and there is NO WARRANTY.
/ * No restriction on use. You can use, modify and redistribute it for
/   personal, non-profit or commercial products UNDER YOUR RESPONSIBILITY.
/ * Redistributions of source code must retain the above copyright notice.
/
/----------------------------------------------------------------------------*/
</code></pre>

<p>因此TJpgDec许可是BSD风格的许可证但存在较大差异。因为TJpgDec是嵌入式项目，对以二进制形式的分发，如嵌入式代码，hex文件或二进制库，未指定以增加其可用性。分发的文档不强制包含关于tjpgdec及其授权文件。TJpgDec是基于GNU GPL兼容的项目。 当有任何修改下重新分发，许可证也可以改为GNU GPL或BSD许可证。</p>

        </div>
        <div class="sharing">







</div>
        



      </div>
    </div>

  </body>
  
</html>
