---
layout:  post
title:  "GDAL添加ECW格式支持"
date:  2017-03-27
categories:  地理信息
tags:  地理信息
comments: 1
---
[TOC]
[博客园原文地址 http://www.cnblogs.com/oloroso/archive/2017/03/27/6625669.html](http://www.cnblogs.com/oloroso/archive/2017/03/27/6625669.html)



# GDAL添加ECW格式支持

本文翻译自 [http://trac.osgeo.org/gdal/wiki/ECW](http://trac.osgeo.org/gdal/wiki/ECW)，有少量的修改及补充。
## ECW

这个驱动程序的最终用户文档:[​http://www.gdal.org/frmt_ecw.html](​http://www.gdal.org/frmt_ecw.html)

## 下载ECW JPEG SDK

为了让GDAL可以使用ECW格式，你需要从[Hexagon Geospatial](http://download.hexagongeospatial.com/download-portal?ProductName=336677bc-d93b-6e30-89b7-ff00003c6ea8)网站下载`ERDAS ECW/JP2 SDK`。
`4.3`或更高版本的`只读SDK`(不支持写ECW文件)需要在同意许可条款后免费下载。如果要通过`ECW SDK`写`ECW`或`JPEG2000`文件，必须从[Hexagon Geospatial/ERDAS](http://download.hexagongeospatial.com)购买可写版本的SDK.

如果可以找到过期的`libecwj 3.3 SDK`，也可以使用它。它的许可信息有显著不同。下面的叙述和讨论基于`3.3 SDK`。

## 在Unix平台构建支持ECW的GDAL

假设您已经在默认位置(`LIBRARY_PATH`)安装了`libecwj`库，那么将`ECW`支持添加到`GDAL`的过程很简单。
只需要在生成编译`GDAL`的`Makefile`的`configure`命令中添加`ecw`库的安装路径：

```bash
$ cd /path/to/gdal
$ ./configure --with-ecw=/usr/local
$ make
# make install
```

如果在构建中存在问题，可以查看`gdal/frmts/ecw/GNUmakefile`中的`CPPFLAGS`是否定义了`-DPOSIX`和`-DLINUX`。参考[#3344](http://trac.osgeo.org/gdal/ticket/3344)

在完成上面步骤后，可以查看GDAL已安装支持格式列表，可以看到有`ECW`:
```bash
$ gdalinfo --formats|grep ECW
  ECW (rw): ERMapper Compressed Wavelets
  JP2ECW (rw+): ERMapper JPEG2000
```
**注意:**所有依赖`GDAL`的服务都应该重启。例如：`Apache`需要重新加载`PHP MapScript`。

## 二进制ECW SDK和GCC >= 5.1

由于`GCC 5.1`以后，GCC默认使用新的`C++ ABI`和`libstdc++`，它与`ECW SDK`二进制文件不兼容（至少当前如此）。解决的办法是使用`CXXFLAGS="-D_GLIBCXX_USE_CXX11_ABI=0"`选项去构建`GDAL`。

```bash
./configure CXXFLAGS="-D_GLIBCXX_USE_CXX11_ABI=0"
```
**注意:**如果你还使用别的使用新的`C++ ABI`的库（例如：likbml，podofo，poppler，cryptopp等，这通常来自发行版自带的），则这个方法无法正常使用。如果你必须使用这些库，你必须找到它们的源码，并使用`CXXFLAGS="-D_GLIBCXX_USE_CXX11_ABI=0"`选项重新编译。

### 在Linux上构建的教程

[​http://trac.osgeo.org/ubuntugis/wiki/UserTutorials](http://trac.osgeo.org/ubuntugis/wiki/UserTutorials)

## 在Windows上构建支持ECW的GDAL

在`nmake.opt`中有以下使用4.1或更新的只读SDK构建读取支持的选项，去掉前面的注释，并修改`ECWDIR`只想的路径。
```bash
# Uncomment the following and update to enable ECW read support with the 
# 4.1+ readonly SDK
#ECWDIR  = 	"c:/Program Files/ERDAS/ERDAS ECW JPEG2000 Read SDK"
#ECWFLAGS =	-DECWSDK_VERSION=41 \
#		-I$(ECWDIR)\include \
#		-I$(ECWDIR)\include/ecw/api -I$(ECWDIR)\include/ecw/jp2 \
#		-I$(ECWDIR)\include/ecw/ecw
#ECWLIB  = 	$(ECWDIR)\lib\vc90\win32\NCSEcw4_RO.lib \
#		$(ECWDIR)\lib\vc90\win32\NCSUtil4.lib \
#		$(ECWDIR)\lib\vc90\win32\NCScnet4.lib
```
GDAL自带的`nmake.opt`还是默认的VS2008，比较老了。
实际上现在nmake.opt里面有两处关于ECWSDK的位置，最新版本的ECWSDK5需使用链接`NCSEcw.lib`或者静态库`NCSEcwS.lib`的即可。如果编译`64位版本，还需要去掉`WIN64=YES`前的`#`，大致在`189`行。
例如在使用`VS2015`编译的时候，修改的位置及结果如下：
```bash
# 45行位置，修改编译器版本
MSVC_VER=1900

# 189行位置，编译64位版本
WIN64=YES

# 303行位置，修改libecwj路径
ECWDIR  = 	"c:/Program Files/ERDAS ECW JPEG 2000 SDK 5.3.0"
ECWFLAGS =	-DECWSDK_VERSION=53 \
		-I$(ECWDIR)\include \
		-I$(ECWDIR)\include/NCSECW/API -I$(ECWDIR)\include/NCSECW/JP2 \
		-I$(ECWDIR)\include/NCSECW/ECW
ECWLIB  = 	$(ECWDIR)\lib\VC140\x64\NCSEcw.lib
```

一旦构建，则需要将一些ECW的dll拷贝到系统路径(程序工作目录也可)中(VC9环境下如下)
```bash
copy "C:\Program Files\ERDAS\ERDAS ECW JPEG2000 Read SDK\redistributable\vc90\win32\*.dll" C:\windows\system32
```
**当前最新版本的为`ECW JPEG 2000 SDK 5.3.0`，使用VC11/12/14编译。**

以上将ECW的支持构建到`GDAL核心DLL`中。
 
为了构建ECW和JP2ECW驱动程序**作为插件**，需要取消`nmake.opt`中注释的插件行：
```bash
# To build ECW support as a plugin uncomment the following, and make sure
# to do "nmake /f makefile.vc plugin" in gdal/frmts/ecw and copy the two
# resulting DLLs to an appropriate place.
ECW_PLUGIN = YES
```

然后到`gdal/frmts/ecw`(在GDAL构建后)中去**创建插件plugins**:
```bash
  nmake /f makefile.vc plugin
```

然后将该目录中生成的`dll`复制到合适的`GDAL`插件目录，例如`.exe`文件所在目录下的`gdalplugins`目录中，或着是`GDAL_DRIVER_PATH`配置选项(或环境变量)指向的目录。

## 在Unix上构建libecwj 3.3库

为了在`Linux``Solaris`或`Mac OS`系统下使用`具有ECW支持`的`GDAL`，您需要自己构建`libecwj`库，因此需要下载`Image Compression SDK`源代码，而不是专门为Windows系统分发的二进制文件。当前版本是`ECW SDK 3.3`，源码包名为`libecwj2-3.3-2006-09-06.zip`。

源码包中有`configure`和`Makefile.in`脚本，还有一个`bootstrap`脚本，可以重新生成`configure`和`Makefile.in`文件。请先确保已经安装了:`autoconf`, `automake`, `m4`, `libtool`程序。

程序的构建示例如下：
```bash
$ cd /path/to/libecwj2-3.3
$ ./configure
$ make
# make install
```
上面配置没有指定安装路径，最后一步需要`superuser`权限。

在SuSE 11(低版本gcc),你需要传递一个`flag`给`configure`脚本去使用`c99`兼容性。

```bash
$ cd /path/to/libecwj2-3.3
$ ./configure CFLAGS="-std=c99"
$ make
# make install
```

默认情况下，安装时使用`prefix`指向目录`/usr/local`来安装`libecwj`。你可以使用`configure`的`--prefix`选项指定。运行`configure --help`查看更多选项。如果编译`libecwj`使用了`--prefix`(例如`/usr/local/libecwj2-3.3`)，则`make install`会失败，因为不会自动创建`<prefix>/include`。执行`mkdir <prefix>/include`(例如`mkdir /usr/local/libecwj2-3.3/include`)，然后再次运行`make install`。

在较新的平台(Fedora 16/17/18和RHEL/CentOS 6)上，`libecwj2`可以在读取`JPEG2000`文件时会导致程序崩溃。错误在与`libecwj2`绑定的`XML`处理代码中，显而易见，这是新的编译器带来的问题。上述平台的一个解决办法是在编译`libecwj2`时禁用优化，可以通过传递`-O0`来配置：

```bash
$ ./configure CFLAGS="-O0" CXXFLAGS="-O0"
```

或者在make时候指定:

```bash
$ make CFLAGS="-O0" CXXFLAGS="-O0"
```
### Mac OS X notes

在Mac OS X上构建`libecwj2-3.3`可能会有一点问题。相关详细信息，参阅[~~#2032~~](http://trac.osgeo.org/gdal/ticket/2032)。

## libecwj2-3.3 补丁

使用最新的编译器从源码构建`libecwj2-3.3`可能需要一些改进，可以在[~~#3162~~](http://trac.osgeo.org/gdal/ticket/3162)中找到`libecwj2`的修复程序和补丁程序中找到。

综合累积可用补丁：
[https://trac.osgeo.org/gdal/attachment/wiki/ECW/libecwj2-3.3.patch](https://trac.osgeo.org/gdal/attachment/wiki/ECW/libecwj2-3.3.patch)

使用`libecwj2-3.3`打开和关闭`ECW`文件占用大量内存的问题，可以使用[http://trac.osgeo.org/mapserver/ticket/3245](http://trac.osgeo.org/mapserver/ticket/3245)补丁来解决。

[~~#3366~~](http://trac.osgeo.org/gdal/ticket/3366)中提供了一个补丁，来避免在`libecwj2-3.3`中的`NCSPhysicalMemorySize()`的`linux`实现中溢出。这个工作可以解决内存大于`2G`的计算机中大内存使用情况。

A patch to fix crash when creating 16 bit JP2 (that occurs on 64bit platforms) is available in ticket [~~#2593~~](http://trac.osgeo.org/gdal/ticket/2593)中提供了修复`16 bit JP2`(在64为平台发生)时出现故障的补丁。

在最新的平台(如Fedora 17，使用GCC 4.7)上修复`ECWInitialize()`崩溃的补丁程序可在[~~#4868~~](http://trac.osgeo.org/gdal/ticket/4868)中找到。

##Open Tickets

[#2162](http://trac.osgeo.org/gdal/ticket/2162) ecw_cs.dat文件出自多云天(provenance cloudy)
[#2340](http://trac.osgeo.org/gdal/ticket/2340) 意大利基准(italian datum)问题。
[#4127](http://trac.osgeo.org/gdal/ticket/4127) [PATCH] ECW文件`ecw_cs.wkt`附加`CRS`定义。